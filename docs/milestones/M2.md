# M2: Persistence hardening

## Goal
- 永続化（`workspace.json`）まわりの堅牢性を上げる
  - 保存が並行して走っても、最終状態が保存される
  - 書き込みを可能な限り安全にする（中途半端なファイルを作らない）
  - 壊れた `workspace.json` があっても起動できる

## Non-goals
- 保存頻度（トリガー/デバウンス）の変更
- 閉じたタブの復元
- データモデルの大改造（例: undoStackの永続化をやめる等）

## Spec

### Frontend
- `save_workspace` の呼び出しは直列化する
  - 前回の保存が完了する前に更新が来た場合はキューに積み、完了後に最新のみを保存する
  - 250ms debounce は維持

### Rust (Tauri)
- 保存フォーマットは JSON pretty print + 改行
- 保存は一時ファイルに書いてからリネームする（可能な範囲でatomic）
- 読み込みでJSONパースに失敗した場合
  - 既存の `workspace.json` を `workspace.json.broken-<timestamp>` に退避
  - 初期Workspaceとして起動できる（= `load_workspace` は `None` を返す）

## Related UX
- `dd` ノード削除は正式仕様（M0/M1に無いが実装済み）

## Acceptance criteria
- 連続操作をしても「古い状態で上書き保存される」ことがない
- `workspace.json` が壊れていても起動できる（退避ファイルが作られる）
- `workspace.json` が人間に読める形式で保存される

